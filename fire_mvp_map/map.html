<!DOCTYPE html>
<html>
<head>
  <title>Fire Detection Map</title>
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>#map{height:95vh}</style>
</head>
<body>
<h3>Fire Triangulation MVP</h3>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SERVER = "https://fire-mvp-backend.onrender.com";

const map = L.map("map").setView([14.6,121.0],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
.addTo(map);

let phoneMarkers = [];
let bearingLines = [];
let fireMarker;

function clearMap() {
  phoneMarkers.forEach(m => map.removeLayer(m));
  bearingLines.forEach(l => map.removeLayer(l));
  phoneMarkers = [];
  bearingLines = [];
}

// Calculate a point along bearing (distance in meters)
function destination(lat, lon, bearing, dist) {
  const R = 6371000;
  const b = bearing * Math.PI / 180;
  const lat1 = lat * Math.PI / 180;
  const lon1 = lon * Math.PI / 180;

  const lat2 = Math.asin(
    Math.sin(lat1)*Math.cos(dist/R) +
    Math.cos(lat1)*Math.sin(dist/R)*Math.cos(b)
  );

  const lon2 = lon1 + Math.atan2(
    Math.sin(b)*Math.sin(dist/R)*Math.cos(lat1),
    Math.cos(dist/R)-Math.sin(lat1)*Math.sin(lat2)
  );

  return [lat2*180/Math.PI, lon2*180/Math.PI];
}

// Refresh map every 3 seconds
setInterval(async () => {
  clearMap();

  const r = await fetch(SERVER + "/reports");
  const reports = await r.json();

  reports.forEach(rep => {
    const start = [rep.lat, rep.lon];
    const end = destination(rep.lat, rep.lon, rep.bearing, 5000);

    phoneMarkers.push(L.marker(start).addTo(map));
    bearingLines.push(
      L.polyline([start,end], {dashArray:"5,5"}).addTo(map)
    );
  });

  const f = await fetch(SERVER + "/latest");
  const fire = await f.json();

  if (fire.lat) {
    if (fireMarker) map.removeLayer(fireMarker);
    fireMarker = L.marker([fire.lat, fire.lon]).addTo(map);
    map.setView([fire.lat, fire.lon],15);
  }
}, 3000);
</script>
</body>
</html>
