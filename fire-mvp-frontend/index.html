<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tower Camera MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}

video {
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

/* Crosshairs */
#crosshair-vertical, #crosshair-horizontal {
  position: fixed;
  background: rgba(255,0,0,0.8);
  z-index: 10;
}

#crosshair-vertical {
  width: 2px;
  height: 100vh;
  left: 50%;
  top: 0;
}

#crosshair-horizontal {
  height: 2px;
  width: 100vw;
  top: 50%;
  left: 0;
}

#controls {
  position: fixed;
  bottom: 10px;
  width: 100%;
  z-index: 20;
}

button, input {
  font-size: 18px;
  padding: 8px;
  margin: 4px;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="crosshair-vertical"></div>
<div id="crosshair-horizontal"></div>

<div id="controls">
  <input id="tower" placeholder="Tower ID (A/B/C)">
  <div id="status">Compass initializing… move phone slowly</div>
  <button onclick="calibrate()">CALIBRATE NORTH</button>
  <button onclick="send()">CONFIRM</button>
</div>

<script>
const BACKEND = "https://fire-mvp-backend.onrender.com";

let lat = null;
let lon = null;
let rawHeading = null;
let heading = null;
let offset = 0;

// CAMERA
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }})
.then(stream => video.srcObject = stream);

// LOCATION
navigator.geolocation.watchPosition(p => {
  lat = p.coords.latitude;
  lon = p.coords.longitude;
});

// COMPASS
function handleOrientation(e){
  if (e.webkitCompassHeading !== undefined) {
    rawHeading = e.webkitCompassHeading;
  } else if (e.alpha !== null) {
    rawHeading = 360 - e.alpha;
  }

  if (rawHeading !== null) {
    heading = (rawHeading + offset + 360) % 360;
    status.innerText = "Heading: " + heading.toFixed(1) + "°";
  }
}

// iOS permission
if (typeof DeviceOrientationEvent?.requestPermission === "function") {
  DeviceOrientationEvent.requestPermission().then(p => {
    if (p === "granted")
      window.addEventListener("deviceorientation", handleOrientation);
  });
} else {
  window.addEventListener("deviceorientationabsolute", handleOrientation);
  window.addEventListener("deviceorientation", handleOrientation);
}

function calibrate(){
  if (rawHeading === null) {
    alert("Compass not ready");
    return;
  }
  offset = (360 - rawHeading) % 360;
  alert("Calibrated. Now point at smoke.");
}

function send(){
  if (lat === null || lon === null || heading === null) {
    alert("Sensors not ready");
    return;
  }

  fetch(BACKEND + "/report", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tower: tower.value || "X",
      lat, lon, bearing: heading
    })
  });

  status.innerText = "Sent ✓";
}
</script>

</body>
</html>
