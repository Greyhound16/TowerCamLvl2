<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fire Tower MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}

video {
  width: 100vw;
  height: 60vh;
  object-fit: cover;
  margin-top: 20px;
}

/* Crosshairs */
.cross-v, .cross-h {
  position: fixed;
  background: rgba(255,0,0,0.8);
  z-index: 10;
}
.cross-v { width: 2px; height: 100vh; left: 50%; top: 0; }
.cross-h { height: 2px; width: 100vw; top: 50%; left: 0; }

#panel {
  position: fixed;
  bottom: 10px;
  width: 100%;
  text-align: center;
  z-index: 20;
}

button, input { font-size: 18px; padding: 6px; margin: 4px; }
</style>
</head>

<body>

<div id="panel">
  <input id="tower" placeholder="Tower ID (A/B/C)">
  <div id="status">Press START to activate camera & GPS</div>
  <button id="startBtn">START</button>
  <button id="confirmBtn" disabled>CONFIRM</button>
</div>

<video id="video" autoplay playsinline></video>
<div class="cross-v"></div>
<div class="cross-h"></div>

<script>
const BACKEND = "https://fire-mvp-backend.onrender.com";

let lat = null, lon = null;
let bearing = 0; // camera-forward
const statusEl = document.getElementById('status');
const confirmBtn = document.getElementById('confirmBtn');
const startBtn = document.getElementById('startBtn');
const video = document.getElementById('video');

// START CAMERA & GPS (iPhone-safe)
startBtn.addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
    video.srcObject = stream;
    statusEl.innerText = "Camera started, waiting for GPS…";

    navigator.geolocation.watchPosition(
      p => {
        lat = p.coords.latitude;
        lon = p.coords.longitude;
        statusEl.innerText = "GPS ready – aim at smoke and tap CONFIRM";
        confirmBtn.disabled = false;
      },
      e => {
        alert("Location error: " + e.message);
        statusEl.innerText = "GPS error";
      },
      { enableHighAccuracy: true }
    );

    startBtn.disabled = true;
  } catch(err) {
    alert("Camera access denied or unavailable: " + err.message);
  }
});

// CONFIRM BUTTON
confirmBtn.addEventListener('click', () => {
  if (lat === null || lon === null) {
    alert("GPS not ready");
    return;
  }

  fetch(BACKEND + "/report", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      tower: document.getElementById('tower').value || "X",
      lat: lat,
      lon: lon,
      bearing: bearing
    })
  });

  statusEl.innerText = "Sent ✓";
});
</script>

</body>
</html>
