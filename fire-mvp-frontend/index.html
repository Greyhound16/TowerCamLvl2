<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fire Tower MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { margin:0; background:black; color:white; font-family:Arial; text-align:center; }
video { width:100vw; height:55vh; object-fit:cover; margin-top:10px; }
.cross-v,.cross-h { position:fixed; background:red; z-index:10; }
.cross-v { width:2px; height:100vh; left:50%; top:0; }
.cross-h { height:2px; width:100vw; top:50%; left:0; }

#panel { position:fixed; bottom:10px; width:100%; z-index:20; }
button,input { font-size:16px; padding:6px; margin:4px; }

#sliderBox { display:none; }
</style>
</head>

<body>

<div id="panel">
  <input id="tower" placeholder="Tower ID (A/B/C)">
  <div id="status">Press START</div>
  <button id="startBtn">START</button>
  <div id="sliderBox">
    <input type="range" id="bearingSlider" min="0" max="360" value="180">
    <div>Bearing: <span id="bearingVal">180</span>°</div>
  </div>
  <button id="confirmBtn" disabled>CONFIRM</button>
</div>

<video id="video" autoplay playsinline></video>
<div class="cross-v"></div>
<div class="cross-h"></div>

<script>
const BACKEND = "https://fire-mvp-backend.onrender.com";

let lat=null, lon=null, bearing=null;
let hasMovedSlider=false;

const statusEl = document.getElementById("status");
const confirmBtn = document.getElementById("confirmBtn");
const sliderBox = document.getElementById("sliderBox");
const bearingSlider = document.getElementById("bearingSlider");
const bearingVal = document.getElementById("bearingVal");

const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);

// SLIDER (iPhone + fallback)
bearingSlider.oninput = () => {
  bearing = Number(bearingSlider.value);
  bearingVal.innerText = bearing;
  hasMovedSlider = true;
  confirmBtn.disabled = false;
};

// START BUTTON — REQUIRED FOR PERMISSIONS
document.getElementById("startBtn").onclick = async () => {
  statusEl.innerText = "Starting camera & GPS…";

  // CAMERA
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"} });
    document.getElementById("video").srcObject = stream;
  } catch {
    alert("Camera permission denied");
    return;
  }

  // GPS (explicit user gesture)
  navigator.geolocation.getCurrentPosition(
    p => {
      lat = p.coords.latitude;
      lon = p.coords.longitude;
      statusEl.innerText = "GPS ready";

      // ANDROID COMPASS
      if (!isIOS) {
        window.addEventListener("deviceorientationabsolute", e => {
          if (e.alpha !== null) {
            bearing = (360 - e.alpha) % 360;
            confirmBtn.disabled = false;
            statusEl.innerText = "Compass active";
          }
        });
      }

      // iPhone → show slider
      if (isIOS) {
        sliderBox.style.display = "block";
        statusEl.innerText = "Aim phone, adjust slider";
      }
    },
    err => {
      alert("Location permission denied");
      statusEl.innerText = "Location blocked";
    },
    { enableHighAccuracy:true }
  );
};

// CONFIRM
confirmBtn.onclick = () => {
  if (lat===null || lon===null || bearing===null) {
    alert("Missing GPS or bearing");
    return;
  }

  fetch(BACKEND + "/report", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      tower: document.getElementById("tower").value || "X",
      lat, lon, bearing
    }
