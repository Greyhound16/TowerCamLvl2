<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fire Triangulation Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>#map{height:100vh;}</style>
</head>

<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const BACKEND = "https://fire-mvp-backend.onrender.com";
const map = L.map("map").setView([15.5,120.6],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let layers=[], firePin=null;

function toRad(d){return d*Math.PI/180;}
function dest(lat,lon,bearing){
  const R=6371;
  const d=2;
  const b=toRad(bearing);
  const lat1=toRad(lat), lon1=toRad(lon);
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(d/R)+Math.cos(lat1)*Math.sin(d/R)*Math.cos(b));
  const lon2=lon1+Math.atan2(Math.sin(b)*Math.sin(d/R)*Math.cos(lat1),Math.cos(d/R)-Math.sin(lat1)*Math.sin(lat2));
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}

function xy(lat,lon){
  const R=6371e3;
  return [R*toRad(lon)*Math.cos(toRad(lat)), R*toRad(lat)];
}
function inv(x,y){
  const R=6371e3;
  return [y/R*180/Math.PI, x/(R*Math.cos(y/R))*180/Math.PI];
}

function intersect(a,b){
  const [x1,y1]=xy(a.lat,a.lon);
  const [x2,y2]=xy(b.lat,b.lon);
  const m1=Math.tan(toRad(a.bearing));
  const m2=Math.tan(toRad(b.bearing));
  const x=(m1*x1-m2*x2+y2-y1)/(m1-m2);
  const y=m1*(x-x1)+y1;
  return inv(x,y);
}

async function update(){
  layers.forEach(l=>map.removeLayer(l));
  layers=[];
  const data=await (await fetch(BACKEND+"/reports")).json();
  const keys=Object.keys(data);

  keys.forEach(k=>{
    const d=data[k];
    const end=dest(d.lat,d.lon,d.bearing);
    layers.push(L.polyline([[d.lat,d.lon],end],{color:"red"}).addTo(map));
    layers.push(L.marker([d.lat,d.lon]).addTo(map));
  });

  if(keys.length>=2){
    const pts=[];
    for(let i=0;i<keys.length;i++)
      for(let j=i+1;j<keys.length;j++)
        pts.push(intersect(data[keys[i]],data[keys[j]]));

    const lat=pts.reduce((s,p)=>s+p[0],0)/pts.length;
    const lon=pts.reduce((s,p)=>s+p[1],0)/pts.length;

    if(firePin) map.removeLayer(firePin);
    firePin=L.marker([lat,lon]).addTo(map);
    map.setView([lat,lon],14);
  }
}

setInterval(update,1500);
</script>
</body>
</html>
